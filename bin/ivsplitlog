#!/usr/bin/env bash

set -euo pipefail
shopt -s nullglob

EDIT=

if [[ $# -ge 1 ]]; then
    if [[ $1 == "-e" ]]; then
        EDIT=1
        shift
    fi

    if [[ $# -ge 1 ]]; then
        LOG="$1"
        shift
    fi
fi

LOG=${LOG#LOG=} # Strip prefix

if [[ ! -e $LOG ]]; then
    # Even if it's been copied back before, try again in case they want to re-fetch a log file that may have grown.

    TMPFILE=$(mktemp /tmp/ivsplitlog.XXXXXX)

    REMOTE_LOG=$LOG

    if [[ ! "$REMOTE_LOG" = *"/"* ]]; then
        REMOTE_LOG=../logs/$REMOTE_LOG
    fi

    echo $LOG not found, trying\ \ \ \ deploy_and_run --get-log "$REMOTE_LOG"
    deploy_and_run --get-log "$REMOTE_LOG" | tee $TMPFILE
    LOG=$(perl -lne 'print if s/LOG=//' $TMPFILE)
    rm $TMPFILE
fi

BASENAME=${LOG##*/}
WORK_DIR=${LOG%/*}/

if [[ ! -w $WORK_DIR ]]; then
    WORK_DIR=~/logs/
fi

OUTPUT_PATH=$WORK_DIR$BASENAME

ANSI_LOG=$OUTPUT_PATH.ansi
CLICK_LOG=$OUTPUT_PATH.clicks.txt
ERROR_LOG=$OUTPUT_PATH.errors.txt
TEXT_LOG=$OUTPUT_PATH.txt

echo ANSI_LOG=$ANSI_LOG
echo CLICK_LOG=$CLICK_LOG
echo ERROR_LOG=$ERROR_LOG
echo TEXT_LOG=$TEXT_LOG

ivrun --fast ivdumplog $LOG -b -o $ANSI_LOG -o $TEXT_LOG

if [[ $EDIT ]]; then
    e -p $TEXT_LOG
fi

ivrun --fast ivdumplog $LOG 'ItemsNamed("deploy_and_run_context"), Errors()'                                                                                   -o $ERROR_LOG
ivrun --fast ivdumplog $LOG 'ItemsNamed("deploy_and_run_context"), ItemsNamed("text", ItemsNamed("Engineering_TypeText")), ItemsNamed("clicked_control_path")' -o $CLICK_LOG

